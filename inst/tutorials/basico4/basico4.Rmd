---
title: "La gramática de los gráficos"
description: "Aprender las reglas de la gramática de los gráficos usando ggplot2"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

<style>
.tutorialTitle {
text-align: left}
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(gapminder)
library(coronavirus)
knitr::opts_chunk$set(echo = FALSE)

# coronavirus <- refresh_coronavirus_jhu()
```

## Introducción

La habilidad de crear gráficos a partir de los datos que recolectamos potencia nuestra capacidad de análisis. Los gráficos nos pueden ayudar a percibir de manera rápida patrones de comportamiento en nuestra data y, al mismo tiempo, resumir de manera visual aquello que queremos mostrar a nuestra audiencia.

Este tutorial tiene como objetivo explicar el uso de la gramática de los gráficos, un marco conceptual cuya aplicación permite realizar visualizaciones de datos de manera sencilla y coherente. No vamos a buscar explicar todos los elementos teóricos que existen detrás del marco conceptual mencionado. En cambio, preferimos explicar sólo los elementos clave, usando ejemplos claros para que, al finalizar el tutorial, cualquiera pueda intentar crear sus propios gráficos.

No somos las primeras personas en tratar de explicar este tema. De hecho, este tutorial será una adaptación del gran trabajo realizado por [Chester Ismay](https://chester.rbind.io/) y [Albert Y. Kim](https://rudeboybert.rbind.io/) en su libro [*Statistical Inference via Data Science: A ModernDive into R and the Tidyverse*](https://moderndive.com/2-viz.html).

## Tema 1: La gramática

El paquete `ggplot2`, elaborado por [Hadley Wickham](http://hadley.nz/) es la implementanción en R de la gramática de los gráficos, teoría desarrollada por [Leland Wilkinson](https://www.cs.uic.edu/~wilkinson/). Puedes cargar `ggplot2` individualmente o junto con los paquetes del `tidyverse`.

```{r library, eval=FALSE, echo=TRUE}
# Sólo ggplot2
library(ggplot2)

# Todo el tidyverse
library(tidyverse)
```

Del mismo modo que para construir una oración en nuestro idioma, hacemos uso de combinaciones de palabras (que pueden ser sustantivos, verbos, adjetivos, etc)  siguiendo un conjunto de reglas conocido como *gramática*, la *gramática de los gráficos* nos brinda las reglas para contruir gráficos estadísticos. 

### Componentes de la gramática

En pocas palabras, la gramática de los gráficos nos quiere decir que:

> Un gráfico estadístico es el **mapeo** de variables en nuestra **data** hacia  atributos **estéticos** de figuras **geométricas**. 

Podemos construir un gráfico a partir de tres componentes esenciales:

1. `data`: el set de datos que contiene las variables de interés
2. `geom`: las figuras geométricas en cuestión. Nos referimos al tipo de objeto que podemos observar en un gráfico. Por ejemplo: puntos, líneas o barras. 
3. `aes`: los atributos estéticos de la figura geométrica. Por ejemplo, su posición en los ejes x/y, color, forma y tamaño. Los atributos estéticos son *mapeados* a las variables contenidas en nuestro set de datos. 

### Un breve ejemplo

Para mostrar lo simple que puede resultar graficar usando los componentes mencionados, usaremos datos del paquete `gapminder`. Para este primer ejemplo utilizaremos sólo los datos de expectativa de vida en Perú a lo largo de los años. Para ello crearemos `df_ejemplo`.

```{r df_ejemplo, echo=TRUE}
library(gapminder)
library(dplyr)

df_ejemplo <- gapminder %>% 
  select(country, year, lifeExp) %>% 
  filter(country == "Peru")
```

Ahora que tenemos `df_ejemplo`, sólo necesitamos usar dos líneas de código para ver la evolución de la expectativa de vida de los peruanos. Recuerda que para ello hemos cargado previamente `ggplot2`.

```{r df_ejemplo_setup}
df_ejemplo <- gapminder %>% 
  select(country, year, lifeExp) %>% 
  filter(country == "Peru")
```

```{r plot_ex1, exercise=TRUE, exercise.setup="df_ejemplo_setup"}
# Ejecuta este código para realizar tu primer gráfico
ggplot(data = df_ejemplo, mapping = aes(x = year, y = lifeExp)) +
  geom_line()
```

¿Cómo funciona la gramática? Anteriormente te habíamos mencionado que `ggplot` requiere tres componentes básicos para crear gráficos: los datos, el mapeo de variables y las figuras geométricas que representarán nuestros datos. En el código de arriba, le indicamos a la función `ggplot()` que nuestra *data* será `df_ejemplo`, con *mapping* le pedimos que mapee la variable `year` al eje *X* y la variable `lifeExp` al eje *Y*. Además de hacer esto, es necesario indicarle qué figura geométrica debe usar `ggplot` para representar nuestros datos. Esta instrucción se la indicamos con `geom_line()`, pidiendole que lo haga con una línea.

### ggplot conciso

Debido a que el primer argumento siempre será nuestra data, y en el mapeo de variables los dos primeros atributos siempre corresponden al eje *X* y al eje *Y*, podemos reescribir el código del gráfico anterior de forma más concisa.

```{r plot_ex2, exercise = TRUE, exercise.setup="df_ejemplo_setup"}
ggplot(df_ejemplo, aes(year, lifeExp)) + 
  geom_line()
```

### Puedo usar pipes

No sólo eso. Recuerda que podemos usar el operador *pipe* para realizar una secuencia de pasos en nuestro análisis siempre y cuando el primer argumento de nuestra función requiera datos, como ocurre con `ggplot`. ¡Esto quiere decir que no era obligatorio crear primero `df_ejemplo`!

```{r plot_ex3, exercise = TRUE, exercise.setup="df_ejemplo_setup"}
gapminder %>% 
  select(country, year, lifeExp) %>% 
  filter(country == "Peru") %>% 
  ggplot(aes(year, lifeExp)) + 
  geom_line()
```

¡Pero no te confíes! Date cuenta que para agregar elementos después de la función `ggplot()`, hacemos uso del operador de suma y no de *pipes*.

## Tema 2: Los cinco gráficos nombrados

Con el fin de conseguir una explicación simple, nos limitamos a mostrar cinco tipos de gráfico que son de uso común y que además permiten entender los usos de la gramática en su forma básica.

### Gráfico de barras o columnas

El primer tipo de gráfico que veremos es el de barras. Resulta muy útil para mostrar la frecuencia de aparición de nuestros datos categóricos. Por ejemplo, podemos ver cuántos países encontramos por continente en las observaciones de `gapminder` correspondientes al año 2002. Podemos obtener esa información usando `dplyr`.

```{r paises, echo=TRUE}
gapminder %>% 
  filter(year == 2002) %>% 
  group_by(continent) %>% 
  summarise(recuento = n()) %>% 
  ungroup()
```

Con esta información, podemos dibujar nuestro primer gráfico de barras haciendo uso de `geom_col()`. Usaremos el còdigo anterior para no tener que crear un nuevo objeto.

```{r geom_col, exercise=TRUE}
gapminder %>% 
  filter(year == 2002) %>% 
  group_by(continent) %>% 
  summarise(recuento = n()) %>% 
  ungroup() %>% 
  ggplot(aes(continent, recuento)) +
  geom_col()
```

Realizar un gráfico de barras con el recuento de observaciones según categorías es tan común, que `ggplot2` incluye una función que nos evita tener que hacer el recuento manualmente. Esta vez crearemos el mismo gráfico usando `geom_bar()`, sin tener que hacer nuestro `recuento` primero.

```{r geom_bar, exercise=TRUE}
gapminder %>% 
  filter(year == 2002) %>% 
  ggplot(aes(continent)) +
  geom_bar()
```

### Gráfico de líneas

El siguiente tipo de gráfico ya lo conocemos. Consiste en líneas que nos sirven generalmente para analizar la evolución en el tiempo de determinadas variables. Debido a ello, es muy común mapear en el exe *X* alguna variable de tiempo, y en el eje *Y* alguna variable cuantitativa, que sería nuestra variable de interés. 

Con `gapminder` podemos analizar la evolución del PBI per cápita peruano de 1952 a 2007. Para ello filtraremos sólo las observaciones pertenecientes a Perú. Para generar el gráfico de líneas usamos `geom_line()`.

```{r geom_line_1, exercise=TRUE}
gapminder %>% 
  filter(country == "Peru") %>% 
  ggplot(aes(year, gdpPercap)) +
  geom_line()
```

¿En qué periodo se ve una gran caída? ¿Cuántos años fueron necesarios para recuperar la misma cifra? Este tipo de preguntas son las que un gráfico de líneas nos permite revisar.

### Histogramas

Es posible hacer otro tipo de análisi usando una sola variable. El gráfico de barras nos mostraba cómo se distribuyen las observaciones de nuestras variables categóricas. Podemos esperar que exista un gráfico que nos muestre la distribución de variables numéricas. 

Esto lo conseguimos con los histogramas.En lugar de mostrar la frecuencia de observaciones según *categorías*, nos permiten agrupar los datos por *intervalos*. Veamos cómo se distribuye el PBI per cápita de todos los países del mundo en el año 2007. Para generar el histograma usamos `geom_histogram()`. Por defecto, `ggplot()` divide nuestra data en 30 intervalos.

```{r geom_histogram, exercise=TRUE}
gapminder %>% 
  filter(year == 2007) %>% 
  ggplot(aes(gdpPercap)) +
  geom_histogram()
```

Con esto podemos responder alguna preguntas como:

- ¿Cuál es el valor más pequeño?¿Y el más alto?
- ¿Cuál es el valor "central" o "más típico"?
- ¿Qué tan dispersos están los valores?
- ¿Qué valores son muy frecuentes?¿Cuáles son infrecuentes?

### Diagramas de caja o boxplot

Otra manera de ver la distribución de nuestros valores es haciendo uso de diagramas de caja o *boxplot*. En este caso, es más entenderlo si primero hemos visto alguno. Para dibujarlo, usamos `geom_boxplot()`. 

```{r geom_boxplot1, exercise=TRUE}
gapminder %>% 
  filter(year == 2007) %>% 
  ggplot(aes(gdpPercap)) +
  geom_boxplot()
```

Lo primero que vemos es una especie de "caja" que busca representar nuestros valores. La línea negra remarcada al centro de la caja nos indica dónde encontramos el punto medio de nuestros datos (la mediana). Esta representación nos permite ubicar nuestros datos en cuatro segmentos importantes:

1. Todo lo que está "fuera" de la caja en el lado izquierdo representa el primer 25% de nuestros datos, también conocido como el primer cuartil o cuartil inferior. Son  los valores más bajos.
2. Todo lo que está en la primera mitad de la "caja" representa el segundo 25% de nuestros datos, conocido el segundo cuartil.
3. Todo lo que está en la segunda mitad de la "caja" representa el tercer 25% de nuestros datos, conocido como el tercer cuartil.
4. Todo lo que está "fuera" de la caja en el lado derecho, representa el cuarto 25% de nuestros datos, también conocido como el cuarto cuartil o cuartil superior. Son los valores más altos.

Habrás podido notar que además aparecen algunos puntos dibujados fuera de nuestros cuatro segmentos. Estos representan valores extremos, también conocidos como *outliers*. Pueden aparecer tanto en el lado más alto como en el más bajo de nuestros datos. Para determinar su existencia se utiliza un cálculo usando el Rango Intercuartil. Si no entiendes esta parte por ahora, no te preocupes, con que entiendas que son valores extremos es suficiente. 

Algo muy útil que nos permiten hacer los *boxplot* es comparar la distribución de nuestros valores entre diferentes categorías. Por ejemplo, el PBI per cápita entre lo cinco continentes.

```{r geom_boxplot2, exercise=TRUE}
gapminder %>% 
  filter(year == 2007) %>% 
  ggplot(aes(gdpPercap, continent)) +
  geom_boxplot()
```

De esta manera, podemos ver que incluso los valores más altos de PBI en África no alcanzan a los valores medianos de Europa y Oceanía. También podemos ver que aunque Asia tiene países con valores de PBI per cápita comparables con los más altos de Europa, al menos la mitad de sus países se ubica en los niveles de África. 

### Diagrama de dispersión

Además de ver las características de una variable en particular, ya sea viendo su evolución en el tiempo o su distribución, podemos pensar en cómo analizar la relación *entre* nuestras variables. Por ejemplo, ¿qué relación existe entre el PBI per cápita y la expectativa de vida? Piensa un poco en esto y trata de responder la siguiente pregunta: ¿Existirá mayor expectativa de vida en países que tienen un PBI per cápita alto?

Para responder a esto podemos hacer uso de un diagrama de dispersión, también conocido como *diagrama de puntos*. Nos sirve para ver la relación existente entre dos variables, también conocida como **correlación**. 

A continuación, analizaremos la relación entre el PBI per cápita y la expectativa de vida de todos los países en el año 2007. Para dibujar nuestro diagrama de puntos, hacemos uso de `geom_point()`. Las variables de interés van en cada uno de nuestros ejes. En este caso, como esperamos que el PBI per cápita influya en la epectativa de vida, lo colocamos en el eje *X*. Cada uno de los puntos de nuestro gráfico corresponde a un país. 

```{r geom_point1, exercise=TRUE}
gapminder %>% 
  filter(year == 2007) %>% 
  ggplot(aes(gdpPercap, lifeExp)) +
  geom_point()
```

Algo que podemos notar rápidamente es que existen gran cantidad de países con un PBI per cápita bajo, esto hace que haya mucha aglomeración en esa parte del gráfico. Aunque esto nos dificulta un poco el análisis, podemos ir respondiendo la siguiente pregunta: ¿La expectativa de vida en los países con mayor PBI per cápita es alta o baja?

Para ver la distribución en los países con menor PBI per cápita podemos filtrar sólo los valores menores a 10000.

```{r geom_point2, exercise=TRUE}
gapminder %>% 
  filter(year == 2007, gdpPercap < 10000) %>% 
  ggplot(aes(gdpPercap, lifeExp)) +
  geom_point()
```

Nuevamente, podemos ver que los países con mayor PBI per cápita tienen la expectativa de vida más alta. Sin embargo, ahora además podemos ver con mayo claridad que aunque en los países con menor PBI per cápita la expectativa de vida es variada, generalmente se encuentra en los valores más bajos.

## Ejercicios

El set de datos `coronavirus` del paquete `coronavirus` contiene datos actualizados acerca de la evolución del COVID-19 a nivel mundial. 

1. Usa funciones explorativas para encontrar información relevante sobre el set de datos (puedes usar `str()`, `summary()`, `head()`, `unique()`). Con esto debes ser capaz de contestar las siguientes preguntas:
    - ¿Para cuántos países tenemos disponible la información?
    - ¿Cuál es la unidad de tiempo que tenemos disponible en las observaciones?
    - ¿Qué tipo de casos están contemplados en el set de datos?

```{r exercise1, exercise=TRUE}


```



